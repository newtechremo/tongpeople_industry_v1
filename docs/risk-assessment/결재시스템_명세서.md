# 문서전자결재 시스템 명세서

> **Version:** 1.0
> **작성일:** 2026.01.12
> **프로젝트:** tong-pass (산업현장통 2.0)

---

## 1. 개요

### 1.1 목적
산업현장의 **문서전자결재** 시스템을 구축하여 위험성평가, TBM 등 안전문서의 결재 프로세스를 전자화합니다.

### 1.2 핵심 용어 정리

| 용어 | 의미 | 주의사항 |
|------|------|----------|
| **결재** (決裁) | 문서 승인 | 구독결제(決濟)와 구분 |
| **결재라인** | 결재자 순서 | 템플릿으로 미리 설정 |
| **결재직책** | 결재서류에 표시되는 직책명 | 조직 내 직책과 별도 |

### 1.3 핵심 설계 원칙

```
❌ 기존 방식: 문서 작성 시 결재자 직접 입력
✅ 새로운 방식: 설정에서 결재라인 템플릿 미리 생성 → 문서 작성 시 선택
```

| 구분 | 기존 | 신규 |
|------|------|------|
| 결재라인 설정 | 문서마다 입력 | **템플릿으로 재사용** |
| 결재자 지정 | 직책(Position) 기반 | **사용자(User) 직접 선택** |
| 결재직책 | 고정 (관리자대표, 총괄책임자...) | **자유 입력** |
| 근로자 대표 | 별도 구분 없음 | **체크박스로 지정 가능** |

---

## 2. 결재라인 템플릿 시스템

### 2.1 개념

```
[설정 > 결재라인 설정]
        │
        ▼
┌─────────────────────────────────────┐
│ 문서 종류별 결재라인 템플릿 관리      │
│                                     │
│ • 위험성평가용 결재라인 1             │
│ • 위험성평가용 결재라인 2             │
│ • TBM용 결재라인                     │
│ • 안전교육용 결재라인                 │
└─────────────────────────────────────┘
        │
        │ 문서 작성 시 선택
        ▼
┌─────────────────────────────────────┐
│ 위험성평가 만들기 > Step 2            │
│                                     │
│ 결재라인 선택: [위험성평가용 1 ▼]     │
│                                     │
│ 미리보기:                            │
│ 근로자대표 → 안전관리자 → 현장소장    │
│   정대호       김철수       이영희    │
└─────────────────────────────────────┘
```

### 2.2 문서 종류

| 코드 | 문서 종류 |
|------|----------|
| `RISK_ASSESSMENT` | 위험성 평가 |
| `TBM` | TBM (Tool Box Meeting) |
| `SAFETY_EDUCATION` | 안전 교육 |
| `WORK_PLAN` | 작업 계획서 |
| `RISK_MEETING` | 위험성 평가 회의록 |

---

## 3. 결재자 구조

### 3.1 Role vs Position vs 결재직책

| 구분 | 설명 | 예시 |
|------|------|------|
| **Role (시스템 권한)** | tong-pass 시스템 내 권한 | `SUPER_ADMIN`, `SITE_ADMIN`, `TEAM_ADMIN`, `WORKER` |
| **Position (조직 내 직책)** | 회사/현장 내 실제 직위 | 안전팀 과장, 현장 소장, 일반근로자 |
| **결재직책 (approvalTitle)** | 결재서류에 표시되는 명칭 | 근로자 대표, 안전관리자, 총괄책임자 |

### 3.2 누가 결재자가 될 수 있나?

> **모든 사용자**가 결재자가 될 수 있습니다.

```typescript
// 결재자는 Role과 무관하게 지정 가능
const approver = {
  userId: 'user-123',
  userName: '정대호',
  position: '일반근로자',      // 조직 내 직책
  approvalTitle: '근로자 대표', // 결재서류에 표시
};
```

**예시:** 일반 근로자(WORKER)도 "근로자 대표"로 결재라인에 포함 가능

### 3.3 근로자 대표 지정

첫 번째 결재자에게 "근로자 대표" 지정 옵션 제공

```
┌────────────────────────────────────────────────┐
│ 결재자1                                         │
│ ┌──────────────────────────────────────────┐   │
│ │ ☑ 근로자 대표 지정                        │   │
│ └──────────────────────────────────────────┘   │
│ 결재직책: [근로자 대표  ] (자동 입력)          │
│ 결재자:   [정대호 ▼]                          │
└────────────────────────────────────────────────┘
```

---

## 4. 결재라인 CRUD 로직

### 4.1 추가 (Add/Push)

```typescript
// 항상 배열 끝에 추가
const handleAddApprover = () => {
  if (approvers.length >= MAX_APPROVERS) {
    alert(`최대 ${MAX_APPROVERS}명까지 추가 가능합니다.`);
    return;
  }
  setApprovers(prev => [
    ...prev,
    { approvalTitle: '', userId: '', userName: '', position: '' }
  ]);
};
```

### 4.2 수정 (Update/Replace)

```typescript
// 해당 인덱스의 데이터만 업데이트 (순서 변경 없음)
const handleUpdateApprover = (index: number, updates: Partial<Approver>) => {
  setApprovers(prev => {
    const newApprovers = [...prev];
    newApprovers[index] = { ...newApprovers[index], ...updates };
    return newApprovers;
  });
};
```

### 4.3 삭제 (Delete + Re-indexing) ⚠️ 핵심

```typescript
/**
 * splice로 삭제 → 자동 재정렬
 * Gap(빈 칸)이 절대 생기지 않도록 함
 */
const handleDeleteApprover = (targetIndex: number) => {
  setApprovers(prev => {
    // 최소 인원 체크
    if (prev.length <= 1) {
      return [{ approvalTitle: '', userId: '', userName: '', position: '' }];
    }

    // splice로 삭제 - 뒤의 모든 요소가 앞으로 당겨짐
    const newApprovers = [...prev];
    newApprovers.splice(targetIndex, 1);

    return newApprovers;
    // 별도의 인덱스 재할당 불필요 (배열 자체가 순서)
  });
};
```

**삭제 전후 예시:**

```
삭제 전: [결재자1, 결재자2, 결재자3, 결재자4]
                    ↑
               (삭제 대상)

삭제 후: [결재자1, 결재자3, 결재자4]
                    ↓
         [결재자1, 결재자2, 결재자3]  ← 자동 재번호
```

### 4.4 제약 조건

| 항목 | 값 | 설명 |
|------|:--:|------|
| 최소 인원 | 2명 | 저장 시 유효성 검사 |
| 최대 인원 | 7명 | 추가 버튼 비활성화 |

---

## 5. TypeScript 타입 정의

```typescript
// types/approval.ts

/** 결재자 정보 */
export interface Approver {
  userId: string;           // 사용자 ID
  userName: string;         // 사용자 이름
  position: string;         // 조직 내 직책
  approvalTitle: string;    // 결재직책 (결재서류에 표시)
}

/** 결재라인 템플릿 */
export interface ApprovalLine {
  id: string;
  name: string;                           // 결재라인 명칭
  documentType: DocumentType;             // 문서 종류
  isPinned: boolean;                      // 고정 여부
  approvers: Approver[];                  // 결재자 목록 (순서대로)
  createdAt: string;
  updatedAt: string;
}

/** 문서 종류 */
export type DocumentType =
  | 'RISK_ASSESSMENT'     // 위험성평가
  | 'TBM'                 // TBM
  | 'SAFETY_EDUCATION'    // 안전 교육
  | 'WORK_PLAN'           // 작업 계획서
  | 'RISK_MEETING';       // 위험성 평가 회의록

/** 결재 상태 */
export type ApprovalStatus =
  | 'PENDING'    // 결재 대기
  | 'APPROVED'   // 승인
  | 'REJECTED';  // 반려

/** 결재 기록 */
export interface ApprovalRecord {
  id: string;
  documentId: string;         // 문서 ID (위험성평가 등)
  documentType: DocumentType;
  approvalLineId: string;
  approverId: string;         // 결재자 ID
  approverName: string;
  approvalTitle: string;      // 결재직책
  sortOrder: number;          // 결재 순서
  status: ApprovalStatus;
  comment?: string;           // 코멘트 (반려 시)
  approvedAt?: string;        // 결재 일시
  createdAt: string;
}
```

---

## 6. Database 스키마

### 6.1 테이블: `approval_lines`

```sql
CREATE TABLE approval_lines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  site_id UUID NOT NULL REFERENCES sites(id),
  company_id UUID NOT NULL REFERENCES companies(id),

  name VARCHAR(100) NOT NULL,
  document_type VARCHAR(30) NOT NULL
    CHECK (document_type IN ('RISK_ASSESSMENT', 'TBM', 'SAFETY_EDUCATION', 'WORK_PLAN', 'RISK_MEETING')),
  is_pinned BOOLEAN DEFAULT FALSE,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_approval_lines_site ON approval_lines(site_id);
CREATE INDEX idx_approval_lines_type ON approval_lines(document_type);
```

### 6.2 테이블: `approval_line_members`

```sql
CREATE TABLE approval_line_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  approval_line_id UUID NOT NULL REFERENCES approval_lines(id) ON DELETE CASCADE,

  user_id UUID NOT NULL REFERENCES users(id),
  user_name VARCHAR(100) NOT NULL,
  position VARCHAR(100),          -- 조직 내 직책
  approval_title VARCHAR(100) NOT NULL,  -- 결재직책
  sort_order INTEGER NOT NULL,    -- 결재 순서 (0부터 시작)
  is_worker_representative BOOLEAN DEFAULT FALSE,  -- 근로자 대표 여부

  created_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE (approval_line_id, sort_order)
);

-- 인덱스
CREATE INDEX idx_approval_members_line ON approval_line_members(approval_line_id);
```

### 6.3 테이블: `approval_records`

```sql
CREATE TABLE approval_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 문서 참조
  document_id UUID NOT NULL,
  document_type VARCHAR(30) NOT NULL,
  approval_line_id UUID NOT NULL REFERENCES approval_lines(id),

  -- 결재자 정보
  approver_id UUID NOT NULL REFERENCES users(id),
  approver_name VARCHAR(100) NOT NULL,
  approval_title VARCHAR(100) NOT NULL,
  sort_order INTEGER NOT NULL,

  -- 결재 상태
  status VARCHAR(20) NOT NULL DEFAULT 'PENDING'
    CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED')),
  comment TEXT,
  approved_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_approval_records_doc ON approval_records(document_id, document_type);
CREATE INDEX idx_approval_records_approver ON approval_records(approver_id);
CREATE INDEX idx_approval_records_status ON approval_records(status);
```

---

## 7. 결재 워크플로우

### 7.1 결재 요청 시

```typescript
async function requestApproval(documentId: string, documentType: DocumentType, approvalLineId: string) {
  // 1. 결재라인 멤버 조회
  const { data: members } = await supabase
    .from('approval_line_members')
    .select('*')
    .eq('approval_line_id', approvalLineId)
    .order('sort_order');

  // 2. 결재 기록 생성
  const records = members.map((member, index) => ({
    document_id: documentId,
    document_type: documentType,
    approval_line_id: approvalLineId,
    approver_id: member.user_id,
    approver_name: member.user_name,
    approval_title: member.approval_title,
    sort_order: index,
    status: index === 0 ? 'PENDING' : 'PENDING', // 첫 번째 결재자부터 시작
  }));

  await supabase.from('approval_records').insert(records);

  // 3. 문서 상태 변경
  await supabase
    .from(getTableName(documentType))
    .update({ status: 'PENDING' })
    .eq('id', documentId);

  // 4. 첫 번째 결재자에게 알림 (TODO)
}
```

### 7.2 결재 처리 시

```typescript
async function processApproval(recordId: string, status: 'APPROVED' | 'REJECTED', comment?: string) {
  // 1. 현재 결재 기록 업데이트
  const { data: record } = await supabase
    .from('approval_records')
    .update({
      status,
      comment,
      approved_at: new Date().toISOString(),
    })
    .eq('id', recordId)
    .select()
    .single();

  if (status === 'REJECTED') {
    // 2a. 반려: 문서 상태 변경
    await supabase
      .from(getTableName(record.document_type))
      .update({ status: 'REJECTED' })
      .eq('id', record.document_id);
    return;
  }

  // 2b. 승인: 다음 결재자 확인
  const { data: nextRecord } = await supabase
    .from('approval_records')
    .select('*')
    .eq('document_id', record.document_id)
    .eq('sort_order', record.sort_order + 1)
    .single();

  if (nextRecord) {
    // 3a. 다음 결재자에게 알림 (TODO)
  } else {
    // 3b. 최종 승인: 문서 상태 변경
    await supabase
      .from(getTableName(record.document_type))
      .update({ status: 'APPROVED' })
      .eq('id', record.document_id);
  }
}
```

### 7.3 결재 흐름 다이어그램

```
[문서 작성]
     │
     ▼
[결재 요청] ──────────────────────────────────────┐
     │                                            │
     ▼                                            │
┌─────────────┐    승인     ┌─────────────┐       │
│ 결재자 1    │ ──────────▶ │ 결재자 2    │       │
│ (근로자대표) │             │ (안전관리자) │       │
└─────────────┘             └─────────────┘       │
     │ 반려                        │              │
     ▼                            ▼ 승인          │
┌─────────────┐            ┌─────────────┐       │
│  반려됨     │            │ 결재자 3    │       │
│  (REJECTED) │            │ (현장소장)   │       │
└─────────────┘            └─────────────┘       │
                                  │              │
                                  ▼ 승인          │
                           ┌─────────────┐       │
                           │  승인완료    │       │
                           │ (APPROVED)  │◀──────┘
                           └─────────────┘
```

---

## 8. UI 컴포넌트

### 8.1 결재라인 미리보기 (가로 스크롤)

```
┌──────────────────────────────────────────────────────────────┐
│ 근로자대표 │ 안전관리자 │ 총괄책임자 │ 안전담당자 │ 현장소장  │
├──────────────────────────────────────────────────────────────┤
│   정대호   │   김철수   │   이영희   │   한수진   │   박민수  │
└──────────────────────────────────────────────────────────────┘
```

### 8.2 결재 상태 표시

```
┌────────────────────────────────────────────────────────┐
│ 결재 확인                                               │
├────────────────────────────────────────────────────────┤
│ ┌──────────┬──────────┬──────────┬──────────┐         │
│ │근로자대표 │안전관리자 │총괄책임자 │안전담당자 │         │
│ │  정대호   │  김철수   │  이영희   │  한수진   │         │
│ │ ✅ 승인  │ ✅ 승인   │ ⏳ 대기   │ ⏳ 대기   │         │
│ │ 01/10    │ 01/11    │          │          │         │
│ └──────────┴──────────┴──────────┴──────────┘         │
└────────────────────────────────────────────────────────┘
```

---

## 9. 구현 상태

### 9.1 완료

| 기능 | 파일 | 상태 |
|------|------|:----:|
| 결재라인 설정 UI | `ApprovalLineSettings.tsx` | ✅ |
| 결재라인 CRUD | `ApprovalLineSettings.tsx` | ✅ |
| 결재자 검색 모달 | `ApprovalLineSettings.tsx` | ✅ |
| 삭제 시 재정렬 | `ApprovalLineSettings.tsx` | ✅ |

### 9.2 TODO

| 기능 | 설명 | 우선순위 |
|------|------|:--------:|
| 결재라인 선택 컴포넌트 | 문서 작성 시 템플릿 선택 | 높음 |
| 결재 워크플로우 | 승인/반려 처리 로직 | 높음 |
| 결재 알림 | 결재 요청 시 푸시 알림 | 중간 |
| 결재 히스토리 | 결재 이력 조회 | 낮음 |

---

## 10. 참고 자료

| 항목 | 위치 |
|------|------|
| 결재라인 설정 컴포넌트 | `src/components/settings/ApprovalLineSettings.tsx` |
| 기획서 | `docs/risk-assessment/위험성평가_기획서.md` |
| 개발 명세서 | `docs/risk-assessment/위험성평가_개발명세서.md` |
