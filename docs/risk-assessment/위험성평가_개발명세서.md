# 위험성평가 개발 명세서

> **Version:** 1.0
> **작성일:** 2026.01.12
> **대상:** 프론트엔드/백엔드 개발자

---

## 1. 개요

### 1.1 목적
tong-pass 관리자 웹의 **위험성평가** 모듈 개발

### 1.2 핵심 기능
1. 위험성평가 **목록** 조회
2. 위험성평가 **만들기** (4단계 위자드)
3. 위험성평가 **상세보기**
4. **AI 추천** 엔진 연동
5. **결재라인** 연동
6. **엑셀/PDF 다운로드** (Phase 2)

### 1.3 기술 스택

| 구분 | 기술 |
|------|------|
| **Frontend** | React 19 + TypeScript 5.8 + Vite 6 |
| **Styling** | Tailwind CSS 3.4 |
| **State** | React Query (@tanstack/react-query) |
| **Backend** | Supabase (PostgreSQL + Edge Functions) |
| **AI 추천** | Supabase Edge Functions (Deno) |

---

## 2. 파일 구조

```
apps/admin-web/src/
├── pages/
│   ├── RiskAssessmentPage.tsx       # 목록 + 유형 선택 화면
│   └── RiskAssessmentFormPage.tsx   # 만들기 폼 (TODO)
├── components/
│   └── risk-assessment/
│       ├── AssessmentTypeSelector.tsx   # 유형 선택 UI
│       ├── AssessmentList.tsx           # 목록 테이블
│       ├── AssessmentForm.tsx           # 만들기 폼
│       ├── AssessmentDetail.tsx         # 상세보기
│       ├── RiskFactorSelector.tsx       # 위험요인 선택 (AI 추천)
│       ├── ApprovalLineSelector.tsx     # 결재라인 선택
│       └── FrequencySeverityMatrix.tsx  # 빈도×강도 매트릭스
├── api/
│   └── risk-assessment.ts           # API 호출 함수
└── types/
    └── risk-assessment.ts           # TypeScript 타입 정의
```

---

## 3. TypeScript 타입 정의

```typescript
// types/risk-assessment.ts

/** 위험성평가 유형 */
export type AssessmentType =
  | 'OCCASIONAL'   // 수시
  | 'INITIAL'      // 최초
  | 'REGULAR'      // 정기
  | 'CONTINUOUS';  // 상시

/** 위험성평가 상태 */
export type AssessmentStatus =
  | 'DRAFT'        // 작성중
  | 'PENDING'      // 결재대기
  | 'APPROVED'     // 승인완료
  | 'REJECTED'     // 반려
  | 'IN_PROGRESS'  // 작업대기중
  | 'COMPLETED';   // 작업종료

/** 위험성 수준 판정 방법 */
export type RiskLevelMethod =
  | 'SIMPLE'       // 상/중/하
  | 'MATRIX';      // 빈도×강도

/** 위험성 등급 (간편법) */
export type SimpleRiskLevel = 'HIGH' | 'MEDIUM' | 'LOW';

/** 재해형태 */
export type AccidentType =
  | 'FALL'           // 떨어짐
  | 'CRUSH'          // 끼임
  | 'STRIKE'         // 부딪힘
  | 'HIT'            // 맞음
  | 'TRIP'           // 넘어짐
  | 'COLLAPSE'       // 무너짐
  | 'ELECTRIC'       // 감전
  | 'FIRE'           // 화재폭발
  | 'ASPHYXIATION'   // 질식
  | 'CUT'            // 절단베임
  | 'MUSCULOSKELETAL'// 근골격계
  | 'TRAFFIC'        // 교통사고
  | 'OTHER';         // 기타

/** 고위험 재해형태 (AI 추천 시 가중치) */
export const HIGH_RISK_ACCIDENT_TYPES: AccidentType[] = [
  'FALL', 'CRUSH', 'ASPHYXIATION', 'FIRE'
];

/** 위험요인 */
export interface RiskFactor {
  id: string;
  taskId: string;
  taskName: string;             // 작업명
  majorCategory: string;        // 대분류
  middleCategory: string;       // 중분류
  workPhase: string;            // 작업 단계
  riskFactor: string;           // 위험요인
  accidentType: AccidentType;   // 재해형태
  currentMeasures: string[];    // 현재 안전조치
  frequency: 1 | 2 | 3 | 4;     // 빈도 (소/중/대/최대)
  severity: 1 | 2 | 3 | 4 | 5;  // 강도 (최하/하/중/상/최상)
  grade: SimpleRiskLevel;       // 등급
  improvementMeasures: {
    technical: string[];        // 기술적 대책
    administrative: string[];   // 관리적 대책
    personal: string[];         // 인적 대책/보호구
  };
}

/** 위험성평가 문서 */
export interface RiskAssessment {
  id: string;
  siteId: string;               // 현장 ID
  companyId: string;            // 회사 ID
  type: AssessmentType;         // 평가 유형
  title: string;                // 문서 제목
  status: AssessmentStatus;     // 상태
  riskLevelMethod: RiskLevelMethod;  // 판정 방법
  workPeriodStart: string;      // 작업 시작일 (ISO 8601)
  workPeriodEnd: string;        // 작업 종료일
  workCategory: string;         // 작업 공종
  approvalLineId: string;       // 결재라인 ID
  riskFactors: RiskFactor[];    // 선택된 위험요인
  createdBy: string;            // 작성자 ID
  createdAt: string;            // 생성일
  updatedAt: string;            // 수정일
}

/** AI 추천 결과 */
export interface RecommendationResult {
  riskFactor: RiskFactor;
  score: number;                // 0~140
  reason: string;               // 추천 근거
}
```

---

## 4. Database 스키마 (Supabase PostgreSQL)

### 4.1 테이블: `risk_assessments`

```sql
CREATE TABLE risk_assessments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  site_id UUID NOT NULL REFERENCES sites(id),
  company_id UUID NOT NULL REFERENCES companies(id),

  -- 기본 정보
  type VARCHAR(20) NOT NULL CHECK (type IN ('OCCASIONAL', 'INITIAL', 'REGULAR', 'CONTINUOUS')),
  title VARCHAR(255) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'DRAFT'
    CHECK (status IN ('DRAFT', 'PENDING', 'APPROVED', 'REJECTED', 'IN_PROGRESS', 'COMPLETED')),

  -- 판정 방법
  risk_level_method VARCHAR(10) NOT NULL DEFAULT 'SIMPLE'
    CHECK (risk_level_method IN ('SIMPLE', 'MATRIX')),

  -- 작업 정보
  work_period_start DATE NOT NULL,
  work_period_end DATE NOT NULL,
  work_category VARCHAR(255) NOT NULL,

  -- 결재
  approval_line_id UUID REFERENCES approval_lines(id),

  -- 메타
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_risk_assessments_site ON risk_assessments(site_id);
CREATE INDEX idx_risk_assessments_status ON risk_assessments(status);
CREATE INDEX idx_risk_assessments_type ON risk_assessments(type);
```

### 4.2 테이블: `risk_assessment_items`

```sql
CREATE TABLE risk_assessment_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assessment_id UUID NOT NULL REFERENCES risk_assessments(id) ON DELETE CASCADE,

  -- 위험요인 정보
  task_name VARCHAR(255) NOT NULL,
  major_category VARCHAR(100) NOT NULL,
  middle_category VARCHAR(100),
  work_phase VARCHAR(100),
  risk_factor TEXT NOT NULL,
  accident_type VARCHAR(30) NOT NULL,

  -- 현재 상태
  current_measures TEXT[],
  frequency SMALLINT CHECK (frequency BETWEEN 1 AND 4),
  severity SMALLINT CHECK (severity BETWEEN 1 AND 5),
  current_grade VARCHAR(10) CHECK (current_grade IN ('HIGH', 'MEDIUM', 'LOW')),

  -- 개선 후
  improvement_technical TEXT[],
  improvement_administrative TEXT[],
  improvement_personal TEXT[],
  improved_frequency SMALLINT CHECK (improved_frequency BETWEEN 1 AND 4),
  improved_severity SMALLINT CHECK (improved_severity BETWEEN 1 AND 5),
  improved_grade VARCHAR(10) CHECK (improved_grade IN ('HIGH', 'MEDIUM', 'LOW')),

  -- 순서
  sort_order INTEGER NOT NULL DEFAULT 0,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_risk_items_assessment ON risk_assessment_items(assessment_id);
```

### 4.3 테이블: `risk_factors_master`

> 18,507건 위험요인 마스터 데이터 (safety_master.db에서 마이그레이션)

```sql
CREATE TABLE risk_factors_master (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id VARCHAR(50) UNIQUE NOT NULL,
  task_name VARCHAR(255) NOT NULL,
  major_category VARCHAR(100) NOT NULL,
  middle_category VARCHAR(100),
  work_phase VARCHAR(100),
  risk_id VARCHAR(50) NOT NULL,
  risk_factor TEXT NOT NULL,
  accident_type VARCHAR(30) NOT NULL,
  current_measures TEXT[],
  frequency VARCHAR(10),
  severity VARCHAR(10),
  grade VARCHAR(10),
  improvement_technical TEXT[],
  improvement_administrative TEXT[],
  improvement_personal TEXT[],

  -- 검색용 풀텍스트
  search_vector TSVECTOR,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_risk_master_category ON risk_factors_master(major_category);
CREATE INDEX idx_risk_master_accident ON risk_factors_master(accident_type);
CREATE INDEX idx_risk_master_search ON risk_factors_master USING GIN(search_vector);

-- 풀텍스트 검색 트리거
CREATE OR REPLACE FUNCTION update_risk_search_vector()
RETURNS TRIGGER AS $$
BEGIN
  NEW.search_vector :=
    setweight(to_tsvector('simple', COALESCE(NEW.task_name, '')), 'A') ||
    setweight(to_tsvector('simple', COALESCE(NEW.risk_factor, '')), 'B') ||
    setweight(to_tsvector('simple', COALESCE(array_to_string(NEW.current_measures, ' '), '')), 'C');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER risk_search_update
  BEFORE INSERT OR UPDATE ON risk_factors_master
  FOR EACH ROW EXECUTE FUNCTION update_risk_search_vector();
```

---

## 5. API 설계

### 5.1 위험성평가 CRUD

```typescript
// api/risk-assessment.ts

import { supabase } from '@/lib/supabase';
import type { RiskAssessment, AssessmentType, AssessmentStatus } from '@/types/risk-assessment';

/** 목록 조회 */
export async function getRiskAssessments(params: {
  siteId: string;
  type?: AssessmentType;
  status?: AssessmentStatus;
  page?: number;
  limit?: number;
}) {
  let query = supabase
    .from('risk_assessments')
    .select('*, approval_lines(*)', { count: 'exact' })
    .eq('site_id', params.siteId)
    .order('created_at', { ascending: false });

  if (params.type) {
    query = query.eq('type', params.type);
  }
  if (params.status) {
    query = query.eq('status', params.status);
  }

  const page = params.page || 1;
  const limit = params.limit || 10;
  const from = (page - 1) * limit;
  const to = from + limit - 1;

  query = query.range(from, to);

  return query;
}

/** 상세 조회 */
export async function getRiskAssessment(id: string) {
  return supabase
    .from('risk_assessments')
    .select(`
      *,
      approval_lines(*),
      risk_assessment_items(*)
    `)
    .eq('id', id)
    .single();
}

/** 생성 */
export async function createRiskAssessment(data: Omit<RiskAssessment, 'id' | 'createdAt' | 'updatedAt'>) {
  return supabase
    .from('risk_assessments')
    .insert(data)
    .select()
    .single();
}

/** 수정 */
export async function updateRiskAssessment(id: string, data: Partial<RiskAssessment>) {
  return supabase
    .from('risk_assessments')
    .update({ ...data, updated_at: new Date().toISOString() })
    .eq('id', id)
    .select()
    .single();
}

/** 삭제 */
export async function deleteRiskAssessment(id: string) {
  return supabase
    .from('risk_assessments')
    .delete()
    .eq('id', id);
}

/** 상태 변경 */
export async function updateAssessmentStatus(id: string, status: AssessmentStatus) {
  return updateRiskAssessment(id, { status });
}
```

### 5.2 AI 추천 API

```typescript
// api/risk-recommendation.ts

import { supabase } from '@/lib/supabase';
import type { RecommendationResult } from '@/types/risk-assessment';

const HIGH_RISK_TYPES = ['FALL', 'CRUSH', 'ASPHYXIATION', 'FIRE'];

/** 위험요인 추천 */
export async function getRecommendations(params: {
  keywords: string[];
  majorCategory?: string;
  limit?: number;
}): Promise<RecommendationResult[]> {
  const { keywords, majorCategory, limit = 50 } = params;

  // 1. 기본 쿼리
  let query = supabase
    .from('risk_factors_master')
    .select('*');

  // 2. 카테고리 필터
  if (majorCategory && majorCategory !== '전체') {
    query = query.eq('major_category', majorCategory);
  }

  // 3. 키워드 검색 (OR 조건)
  if (keywords.length > 0) {
    const searchTerms = keywords.join(' | ');
    query = query.textSearch('search_vector', searchTerms);
  }

  const { data, error } = await query.limit(limit * 2); // 점수 계산 후 필터링 위해 여유있게

  if (error) throw error;
  if (!data) return [];

  // 4. 점수 계산
  const scored = data.map(item => {
    let score = 0;
    let reasons: string[] = [];

    for (const keyword of keywords) {
      const kw = keyword.toLowerCase();

      // 작업명 매칭 (+40)
      if (item.task_name?.toLowerCase().includes(kw)) {
        score += 40;
        reasons.push(`작업명 '${keyword}' 매칭`);
      }
      // 위험요인 매칭 (+20)
      if (item.risk_factor?.toLowerCase().includes(kw)) {
        score += 20;
        reasons.push(`위험요인 '${keyword}' 매칭`);
      }
      // 대책 매칭 (+10)
      const measures = [
        ...(item.current_measures || []),
        ...(item.improvement_technical || []),
        ...(item.improvement_personal || [])
      ].join(' ').toLowerCase();
      if (measures.includes(kw)) {
        score += 10;
        reasons.push(`대책 '${keyword}' 매칭`);
      }
    }

    // 고위험 재해형태 (+30)
    if (HIGH_RISK_TYPES.includes(item.accident_type)) {
      score += 30;
      reasons.push(`고위험 재해형태 '${item.accident_type}'`);
    }

    // 복합 매칭 보너스 (+30)
    if (reasons.length >= 2) {
      score += 30;
      reasons.push('복합 매칭 보너스');
    }

    return {
      riskFactor: item,
      score,
      reason: reasons.join(' + ')
    };
  });

  // 5. 점수순 정렬 + 중복 제거 + 상위 N개
  const unique = new Map<string, RecommendationResult>();
  for (const item of scored) {
    const key = item.riskFactor.risk_factor;
    if (!unique.has(key) || unique.get(key)!.score < item.score) {
      unique.set(key, item);
    }
  }

  return Array.from(unique.values())
    .sort((a, b) => b.score - a.score)
    .slice(0, limit);
}
```

---

## 6. 컴포넌트 구현 가이드

### 6.1 빈도×강도 매트릭스 컴포넌트

```tsx
// components/risk-assessment/FrequencySeverityMatrix.tsx

interface Props {
  frequency: number;      // 1~4
  severity: number;       // 1~5
  onChange: (f: number, s: number) => void;
  disabled?: boolean;
}

const FREQUENCY_LABELS = ['소(1)', '중(2)', '대(3)', '최대(4)'];
const SEVERITY_LABELS = ['최하(1)', '하(2)', '중(3)', '상(4)', '최상(5)'];

function getGrade(f: number, s: number): { score: number; level: string; color: string } {
  const score = f * s;
  if (score >= 15) return { score, level: '고등급', color: 'bg-red-100 text-red-700' };
  if (score >= 7) return { score, level: '중등급', color: 'bg-yellow-100 text-yellow-700' };
  return { score, level: '하등급', color: 'bg-green-100 text-green-700' };
}

export default function FrequencySeverityMatrix({ frequency, severity, onChange, disabled }: Props) {
  const grade = getGrade(frequency, severity);

  return (
    <div className="space-y-4">
      {/* 빈도 선택 */}
      <div>
        <label className="text-sm font-medium text-slate-700">빈도 (가능성)</label>
        <div className="flex gap-2 mt-2">
          {FREQUENCY_LABELS.map((label, i) => (
            <button
              key={i}
              onClick={() => onChange(i + 1, severity)}
              disabled={disabled}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                ${frequency === i + 1
                  ? 'bg-orange-500 text-white'
                  : 'bg-gray-100 text-slate-600 hover:bg-gray-200'
                } ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
            >
              {label}
            </button>
          ))}
        </div>
      </div>

      {/* 강도 선택 */}
      <div>
        <label className="text-sm font-medium text-slate-700">강도 (중대성)</label>
        <div className="flex gap-2 mt-2">
          {SEVERITY_LABELS.map((label, i) => (
            <button
              key={i}
              onClick={() => onChange(frequency, i + 1)}
              disabled={disabled}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors
                ${severity === i + 1
                  ? 'bg-orange-500 text-white'
                  : 'bg-gray-100 text-slate-600 hover:bg-gray-200'
                } ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
            >
              {label}
            </button>
          ))}
        </div>
      </div>

      {/* 결과 표시 */}
      <div className={`p-4 rounded-lg ${grade.color}`}>
        <p className="font-bold">위험성 점수: {grade.score}점</p>
        <p className="text-sm">등급: {grade.level}</p>
      </div>
    </div>
  );
}
```

---

## 7. 데이터 마이그레이션

### 7.1 safety_master.db → Supabase 마이그레이션

```bash
# 1. SQLite에서 JSON 추출
sqlite3 safety_master.db "SELECT json_group_array(json_object(
  'task_id', task_id,
  'task_name', task_name,
  'risk_factor', risk_factor,
  'accident_type', accident_type
  -- ... 나머지 필드
)) FROM risk_assessment;" > risk_factors.json

# 2. Supabase CLI로 import
supabase db push
supabase db seed --file risk_factors.json
```

### 7.2 마이그레이션 스크립트 (Node.js)

```typescript
// scripts/migrate-risk-factors.ts

import Database from 'better-sqlite3';
import { createClient } from '@supabase/supabase-js';

const sqlite = new Database('safety_master.db');
const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

async function migrate() {
  const rows = sqlite.prepare('SELECT * FROM risk_assessment').all();

  console.log(`총 ${rows.length}건 마이그레이션 시작...`);

  // 배치 처리 (1000건씩)
  const batchSize = 1000;
  for (let i = 0; i < rows.length; i += batchSize) {
    const batch = rows.slice(i, i + batchSize).map(row => ({
      task_id: row.task_id,
      task_name: row.task_name,
      major_category: row.major_category || '기타',
      middle_category: row.middle_category,
      work_phase: row.work_phase,
      risk_id: row.risk_id,
      risk_factor: row.risk_factor,
      accident_type: row.accident_type,
      current_measures: row.current_measures?.split(',') || [],
      frequency: row.frequency,
      severity: row.severity,
      grade: row.grade,
      improvement_technical: row.measures_tech?.split(',') || [],
      improvement_administrative: row.measures_admin?.split(',') || [],
      improvement_personal: row.measures_personal?.split(',') || [],
    }));

    const { error } = await supabase
      .from('risk_factors_master')
      .insert(batch);

    if (error) {
      console.error(`배치 ${i}~${i + batchSize} 실패:`, error);
    } else {
      console.log(`배치 ${i}~${i + batchSize} 완료`);
    }
  }

  console.log('마이그레이션 완료!');
}

migrate();
```

---

## 8. 참고 자료

| 항목 | 위치 |
|------|------|
| 기획서 | `docs/risk-assessment/위험성평가_기획서.md` |
| 결재 시스템 | `docs/risk-assessment/결재시스템_명세서.md` |
| 위험요인 DB | `tong-riskmanagement/output/safety_master.db` |
| 추천 알고리즘 원본 | `tong-riskmanagement/core/recommender.py` |
| Figma 디자인 | `tong-riskmanagement/reference/figma/` |
