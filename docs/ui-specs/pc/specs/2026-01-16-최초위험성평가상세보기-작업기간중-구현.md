# 최초 위험성평가 상세보기 (작업기간중) - 구현 명세서

> **원본**: `C:\hongtong\reference\figma\위험성평가 PC관리자\현장통 2.0 PC 관리자 -위험성평가 문서 상세보기 및 수시 상세보기에서 추가 화면.mp4`
> **생성일**: 2026-01-16
> **플랫폼**: PC (admin-web)
> **문서 유형**: 구현 명세서 (2단계)
> **기획 문서**: `docs/ui-specs/pc/plans/2026-01-16-최초위험성평가상세보기-작업기간중-기획.md`

---

## 1. 컴포넌트 구조

### 1.1 파일 구조 (추가/수정 컴포넌트)

```
src/
├── components/
│   └── risk-assessment/
│       └── detail/
│           ├── ApprovalLineEditable.tsx       # 결재 라인 (수정 가능) ✨ 신규
│           ├── ApproverEditModal.tsx          # 결재자 수정 모달 ✨ 신규
│           └── ApproverSearchInput.tsx        # 결재자 검색 입력 ✨ 신규
└── hooks/
    └── risk-assessment/
        └── useApproverManagement.ts           # 결재자 관리 훅 ✨ 신규
```

### 1.2 컴포넌트 트리 (작업기간중)

```
InitialAssessmentDetailPage
├── AssessmentDetailHeader
│   ├── ExportDropdown
│   ├── DeleteButton
│   └── EditButton                    # ✨ 작업기간중만 표시
├── AssessmentBasicInfo
├── ApprovalLineEditable              # ✨ 작업기간중용 (수정 가능)
│   ├── ApproverCard[]
│   └── EditIcon (연필 아이콘)
├── RiskFactorCardList
│   └── RiskFactorCard[]
├── ApproverEditModal                 # ✨ 결재자 수정 모달
│   └── ApproverSearchInput
└── DeleteConfirmModal
```

---

## 2. 컴포넌트 명세

### 2.1 AssessmentDetailHeader (수정)

```tsx
interface AssessmentDetailHeaderProps {
  assessmentType: 'initial' | 'adhoc';
  title: string;
  status: 'in_progress' | 'completed';
  onExport: (format: 'pdf' | 'excel') => void;
  onDelete: () => void;
  onEdit?: () => void;           // ✨ 수정 버튼 콜백 추가
  canEdit: boolean;
}
```

**상태 뱃지 스타일링**:
```tsx
// 작업기간중 뱃지
className="px-3 py-1 text-sm font-medium rounded-full bg-orange-500 text-white"

// 작업종료 뱃지
className="px-3 py-1 text-sm font-medium rounded-full bg-gray-500 text-white"

// 수정 버튼 (작업기간중만)
className="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg hover:from-orange-600 hover:to-orange-700"
```

### 2.2 ApprovalLineEditable

**파일**: `src/components/risk-assessment/detail/ApprovalLineEditable.tsx`

```tsx
interface ApprovalLineEditableProps {
  approvers: Approver[];
  onEditClick: () => void;
  canEdit: boolean;
}
```

**스타일링**:
```tsx
// 섹션 헤더
className="flex items-center justify-between mb-4"

// 제목
className="text-lg font-bold text-slate-800"

// 수정 아이콘 버튼
className="p-2 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer"

// 스크롤 컨테이너
className="flex gap-4 overflow-x-auto py-4 px-2 scrollbar-thin scrollbar-thumb-gray-300"

// 결재자 카드
className="flex-shrink-0 flex flex-col items-center p-4 bg-white border border-gray-200 rounded-xl min-w-[120px] shadow-sm"

// 연결선 (→)
className="flex-shrink-0 flex items-center text-gray-400"
```

### 2.3 ApproverEditModal

**파일**: `src/components/risk-assessment/detail/ApproverEditModal.tsx`

```tsx
interface ApproverEditModalProps {
  isOpen: boolean;
  onClose: () => void;
  currentApprovers: Approver[];
  onSave: (approvers: Approver[]) => Promise<void>;
}
```

**스타일링**:
```tsx
// 모달 컨테이너
className="bg-white rounded-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden"

// 모달 헤더
className="flex items-center justify-between p-6 border-b border-gray-200"

// 모달 제목
className="text-xl font-bold text-gray-900"

// 닫기 버튼
className="p-2 rounded-lg hover:bg-gray-100"

// 현재 결재 라인 영역
className="p-6 bg-gray-50"

// 결재자 카드 (수정 모드)
className="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg"

// 삭제 버튼 (X)
className="p-1 rounded hover:bg-red-100 text-red-500"

// 추가 버튼 ([+])
className="flex items-center justify-center w-12 h-12 border-2 border-dashed border-gray-300 rounded-lg hover:border-orange-400 cursor-pointer"

// 검색 영역
className="p-6 border-t border-gray-200"

// 검색 결과 리스트
className="max-h-48 overflow-y-auto border border-gray-200 rounded-lg mt-2"

// 검색 결과 아이템
className="flex items-center gap-3 p-3 hover:bg-orange-50 cursor-pointer"

// 버튼 그룹
className="flex gap-3 p-6 border-t border-gray-200"

// 취소 버튼
className="flex-1 px-4 py-3 text-gray-700 bg-gray-100 rounded-xl font-medium hover:bg-gray-200"

// 저장 버튼
className="flex-1 px-4 py-3 text-white bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl font-medium"
```

### 2.4 ApproverSearchInput

**파일**: `src/components/risk-assessment/detail/ApproverSearchInput.tsx`

```tsx
interface ApproverSearchInputProps {
  onSelect: (user: User) => void;
  excludeIds?: string[];           // 이미 선택된 결재자 제외
}
```

**스타일링**:
```tsx
// 검색 입력 필드
className="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"

// 검색 아이콘
className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"
```

---

## 3. 상태 관리

### 3.1 useApproverManagement 훅

**파일**: `src/hooks/risk-assessment/useApproverManagement.ts`

```tsx
interface UseApproverManagementReturn {
  approvers: Approver[];
  addApprover: (user: User) => void;
  removeApprover: (approverId: string) => void;
  reorderApprovers: (fromIndex: number, toIndex: number) => void;
  saveApprovers: () => Promise<void>;
  isLoading: boolean;
  canRemove: (approver: Approver) => boolean;  // 삭제 가능 여부
}

function useApproverManagement(
  assessmentId: string,
  initialApprovers: Approver[]
): UseApproverManagementReturn {
  const [approvers, setApprovers] = useState(initialApprovers);

  const canRemove = (approver: Approver) => {
    // 이미 결재 완료된 결재자는 삭제 불가
    return approver.status !== 'approved';
  };

  const addApprover = (user: User) => {
    const newApprover: Approver = {
      id: user.id,
      name: user.name,
      position: user.position,
      profileImage: user.profileImage,
      status: 'pending',
      order: approvers.length + 1,
    };
    setApprovers([...approvers, newApprover]);
  };

  const removeApprover = (approverId: string) => {
    if (!canRemove(approvers.find(a => a.id === approverId)!)) {
      return;
    }
    setApprovers(approvers.filter(a => a.id !== approverId));
  };

  // ...
}
```

### 3.2 결재자 검색 훅

```tsx
function useApproverSearch() {
  const [query, setQuery] = useState('');

  const { data: searchResults, isLoading } = useQuery({
    queryKey: ['approver-search', query],
    queryFn: () => searchApprovers(query),
    enabled: query.length >= 2,
  });

  return { query, setQuery, searchResults, isLoading };
}
```

---

## 4. API 연동

### 4.1 결재자 목록 수정

```tsx
// PUT /api/risk-assessments/initial/{id}/approvers
interface UpdateApproversRequest {
  approvers: {
    userId: string;
    order: number;
  }[];
}

async function updateApprovers(
  assessmentId: string,
  approvers: UpdateApproversRequest['approvers']
): Promise<void> {
  await apiClient.put(`/risk-assessments/initial/${assessmentId}/approvers`, {
    approvers,
  });
}
```

### 4.2 결재자 검색

```tsx
// GET /api/users/search?q={keyword}&role=approver
interface SearchApproversResponse {
  users: {
    id: string;
    name: string;
    position: string;
    department: string;
    profileImage?: string;
  }[];
}

async function searchApprovers(query: string): Promise<SearchApproversResponse> {
  const response = await apiClient.get('/users/search', {
    params: { q: query, role: 'approver' },
  });
  return response.data;
}
```

---

## 5. 상태별 분기 로직

### 5.1 페이지 레벨 분기

```tsx
function InitialAssessmentDetailPage() {
  const { data } = useInitialAssessmentDetail(id);

  const isEditable = data?.status === 'in_progress';

  return (
    <div>
      <AssessmentDetailHeader
        // ...
        canEdit={isEditable}
        onEdit={isEditable ? handleEdit : undefined}
      />

      {isEditable ? (
        <ApprovalLineEditable
          approvers={data.approvers}
          onEditClick={openApproverModal}
          canEdit={true}
        />
      ) : (
        <ApprovalLineReadonly approvers={data.approvers} />
      )}

      {/* ... */}
    </div>
  );
}
```

---

## 6. 구현 체크리스트

### 6.1 신규 컴포넌트

- [ ] ApprovalLineEditable
- [ ] ApproverEditModal
- [ ] ApproverSearchInput

### 6.2 수정 컴포넌트

- [ ] AssessmentDetailHeader (수정 버튼 추가)
- [ ] InitialAssessmentDetailPage (상태별 분기)

### 6.3 훅 및 API

- [ ] useApproverManagement
- [ ] useApproverSearch
- [ ] updateApprovers API
- [ ] searchApprovers API

---

## 7. 연결 문서

- 기획 문서: `docs/ui-specs/pc/plans/2026-01-16-최초위험성평가상세보기-작업기간중-기획.md`
- 작업종료 구현: `docs/ui-specs/pc/specs/2026-01-16-최초위험성평가상세보기-작업종료-구현.md`
