# 수시 위험성평가 상세보기 (작업기간중) - 구현 명세서

> **원본**: `C:\hongtong\reference\figma\위험성평가 PC관리자\현장통 2.0 PC 관리자 -위험성평가 문서 상세보기 및 수시 상세보기에서 추가 화면.mp4`
> **생성일**: 2026-01-16
> **플랫폼**: PC (admin-web)
> **문서 유형**: 구현 명세서 (2단계)
> **기획 문서**: `docs/ui-specs/pc/plans/2026-01-16-수시위험성평가상세보기-작업기간중-기획.md`

---

## 1. 컴포넌트 구조

### 1.1 파일 구조

```
src/
├── pages/
│   └── risk-assessment/
│       └── AdhocAssessmentDetailPage.tsx          # 메인 페이지
├── components/
│   └── risk-assessment/
│       └── detail/
│           │── adhoc/
│           │   ├── AdhocDetailHeader.tsx          # 수시 전용 헤더
│           │   ├── FrequencyIntensityCard.tsx     # 빈도·강도 위험요인 카드
│           │   ├── ActionInfoSection.tsx          # 조치 정보 섹션
│           │   ├── ReviewContentInput.tsx         # 검토 내용 입력
│           │   ├── ReviewTagList.tsx              # 검토 태그 목록
│           │   ├── OptionalInfoSection.tsx        # 선택 정보 입력 영역
│           │   ├── TagInputField.tsx              # 태그 입력 필드
│           │   ├── TagBadge.tsx                   # 태그 뱃지
│           │   ├── CollapsibleSection.tsx         # 접이식 섹션
│           │   ├── UnconfirmedWorkerSection.tsx   # 미확인 근로자 섹션
│           │   ├── AdditionalRiskSection.tsx      # 추가 위험 요인 섹션
│           │   ├── AdditionalRiskCard.tsx         # 추가 위험 요인 카드
│           │   ├── ActionResultSection.tsx        # 조치 결과 섹션
│           │   ├── ActionResultCard.tsx           # 조치 결과 카드
│           │   ├── AdditionalRiskModal.tsx        # 추가 위험 요인 모달
│           │   ├── ActionResultModal.tsx          # 조치 결과 모달
│           │   ├── PhotoUploader.tsx              # 사진 업로드
│           │   ├── PrivacyConsentModal.tsx        # 개인정보 동의 모달
│           │   └── SuccessMessageModal.tsx        # 성공 메시지 모달
│           └── shared/
│               └── SubCategoryDropdown.tsx        # 작업 공종 드롭다운
└── hooks/
    └── risk-assessment/
        ├── useAdhocAssessmentDetail.ts            # 상세 조회 훅
        ├── useReviewContent.ts                    # 검토 내용 관리 훅
        ├── useTagInput.ts                         # 태그 입력 훅
        ├── useAdditionalRisk.ts                   # 추가 위험 요인 훅
        └── useActionResult.ts                     # 조치 결과 훅
```

### 1.2 컴포넌트 트리

```
AdhocAssessmentDetailPage
├── AdhocDetailHeader
│   ├── RewriteButton (재작성)
│   ├── ExportDropdown
│   └── DeleteButton
├── ApprovalLineEditable
├── FrequencyIntensityCard[] (빈도·강도 위험요인)
│   ├── ActionInfoSection
│   ├── ReviewContentInput
│   └── ReviewTagList
├── OptionalInfoSection
│   ├── TagInputField (순회점검사항)
│   └── TagInputField (아차사고)
├── CollapsibleSection (금일 미확인 근로자)
│   └── UnconfirmedWorkerSection
├── CollapsibleSection (추가 위험 요인)
│   └── AdditionalRiskSection
│       ├── RegisterButton
│       └── AdditionalRiskCard[]
├── CollapsibleSection (조치 결과)
│   └── ActionResultSection
│       ├── RegisterButton
│       └── ActionResultCard[]
├── AdditionalRiskModal
├── ActionResultModal
├── PrivacyConsentModal
└── SuccessMessageModal
```

---

## 2. 컴포넌트 명세

### 2.1 FrequencyIntensityCard

**파일**: `src/components/risk-assessment/detail/adhoc/FrequencyIntensityCard.tsx`

```tsx
interface FrequencyIntensityCardProps {
  riskFactor: {
    id: string;
    description: string;
    currentMeasures: string;
    frequency: number;           // 빈도 (1-5)
    intensity: number;           // 강도 (1-4)
    grade: 'low' | 'medium' | 'high';
    improvedFrequency?: number;  // 개선 후 빈도
    improvedIntensity?: number;  // 개선 후 강도
    improvedGrade?: 'low' | 'medium' | 'high';
    actionInfo: {
      actionDate?: string;
      actionPerson?: string;
      actionConfirmer?: string;
    };
    reviews: { id: string; content: string }[];
  };
  onAddReview: (content: string) => Promise<void>;
  onDeleteReview: (reviewId: string) => Promise<void>;
}
```

**스타일링**:
```tsx
// 카드 컨테이너
className="p-6 bg-white border border-gray-200 rounded-xl space-y-6"

// 빈도/강도/등급 그리드
className="grid grid-cols-3 gap-4"

// 숫자 표시 박스
className="flex items-center justify-center w-12 h-12 bg-gray-100 rounded-lg text-lg font-bold"

// 등급 뱃지 - 하
className="px-4 py-2 rounded-full bg-green-100 text-green-700 font-medium"

// 등급 뱃지 - 중
className="px-4 py-2 rounded-full bg-yellow-100 text-yellow-700 font-medium"

// 등급 뱃지 - 상
className="px-4 py-2 rounded-full bg-red-100 text-red-700 font-medium"

// 개선 후 섹션
className="p-4 bg-blue-50 rounded-lg"
```

### 2.2 TagInputField

**파일**: `src/components/risk-assessment/detail/adhoc/TagInputField.tsx`

```tsx
interface TagInputFieldProps {
  label: string;
  tags: { id: string; content: string }[];
  onAdd: (content: string) => Promise<void>;
  onRemove: (tagId: string) => Promise<void>;
  placeholder?: string;
}
```

**스타일링**:
```tsx
// 컨테이너
className="space-y-3"

// 라벨
className="text-sm font-medium text-gray-700"

// 입력 영역
className="flex gap-2"

// 입력 필드
className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"

// 추가하기 버튼
className="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg hover:from-orange-600 hover:to-orange-700"

// 태그 목록
className="flex flex-wrap gap-2"
```

### 2.3 TagBadge

**파일**: `src/components/risk-assessment/detail/adhoc/TagBadge.tsx`

```tsx
interface TagBadgeProps {
  content: string;
  onRemove?: () => void;
  variant?: 'default' | 'danger';  // 아차사고는 danger
}
```

**스타일링**:
```tsx
// 기본 태그
className="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm"

// 위험 태그 (아차사고)
className="inline-flex items-center gap-1 px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm"

// 삭제 버튼
className="p-0.5 rounded-full hover:bg-gray-200"
```

### 2.4 CollapsibleSection

**파일**: `src/components/risk-assessment/detail/adhoc/CollapsibleSection.tsx`

```tsx
interface CollapsibleSectionProps {
  title: string;
  count?: number;
  defaultOpen?: boolean;
  children: React.ReactNode;
}
```

**스타일링**:
```tsx
// 헤더 (클릭 영역)
className="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50 rounded-lg"

// 제목
className="text-lg font-bold text-slate-800"

// 건수 뱃지
className="px-2 py-0.5 text-sm bg-gray-200 text-gray-700 rounded-full ml-2"

// 화살표 아이콘 (회전)
className={`w-5 h-5 text-gray-500 transition-transform ${isOpen ? 'rotate-180' : ''}`}

// 콘텐츠 영역
className="px-4 pb-4"
```

### 2.5 AdditionalRiskCard

**파일**: `src/components/risk-assessment/detail/adhoc/AdditionalRiskCard.tsx`

```tsx
interface AdditionalRiskCardProps {
  risk: {
    id: string;
    photoUrl?: string;
    content: string;
    createdAt: string;
    createdBy: {
      name: string;
      company: string;
      position: string;
    };
  };
  onEdit: () => void;
  onDelete: () => void;
}
```

**스타일링**:
```tsx
// 카드 컨테이너
className="flex gap-4 p-4 bg-white border border-gray-200 rounded-xl"

// 썸네일 이미지
className="w-24 h-24 rounded-lg object-cover bg-gray-100 flex-shrink-0"

// 플레이스홀더 (이미지 없음)
className="w-24 h-24 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0"

// 정보 영역
className="flex-1 space-y-2"

// 내용 텍스트
className="text-gray-900"

// 메타 정보
className="text-sm text-gray-500"

// 버튼 그룹
className="flex gap-2"

// 삭제 버튼
className="px-3 py-1.5 text-sm text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200"

// 수정 버튼
className="px-3 py-1.5 text-sm text-white bg-gray-700 rounded-lg hover:bg-gray-800"
```

### 2.6 AdditionalRiskModal

**파일**: `src/components/risk-assessment/detail/adhoc/AdditionalRiskModal.tsx`

```tsx
interface AdditionalRiskModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: { photo?: File; content: string }) => Promise<void>;
  initialData?: { photoUrl?: string; content: string };  // 수정 시
  mode: 'create' | 'edit';
}
```

**스타일링**:
```tsx
// 모달 컨테이너
className="bg-white rounded-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-hidden"

// 모달 헤더
className="flex items-center justify-between p-6 border-b border-gray-200"

// 모달 본문
className="p-6 space-y-6"

// 필드 라벨
className="text-sm font-medium text-gray-700 mb-2"

// 버튼 그룹
className="flex gap-3 p-6 border-t border-gray-200"

// 취소 버튼
className="flex-1 px-4 py-3 text-gray-700 bg-gray-100 rounded-xl font-medium hover:bg-gray-200"

// 선택 완료 버튼
className="flex-1 px-4 py-3 text-white bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl font-medium disabled:opacity-50"
```

### 2.7 ActionResultModal

**파일**: `src/components/risk-assessment/detail/adhoc/ActionResultModal.tsx`

```tsx
interface ActionResultModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: {
    photo?: File;
    subCategoryId: string;
    content: string;
  }) => Promise<void>;
  subCategories: { id: string; name: string }[];  // 작업 공종 목록
  initialData?: {
    photoUrl?: string;
    subCategoryId: string;
    content: string;
  };
  mode: 'create' | 'edit';
}
```

### 2.8 PhotoUploader

**파일**: `src/components/risk-assessment/detail/adhoc/PhotoUploader.tsx`

```tsx
interface PhotoUploaderProps {
  value?: File | string;  // File(새 업로드) 또는 URL(기존)
  onChange: (file: File | null) => void;
  onRequireConsent: () => void;  // 개인정보 동의 필요 시
  hasConsent: boolean;
}
```

**스타일링**:
```tsx
// 업로드 영역 (이미지 없음)
className="w-32 h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-orange-400"

// 미리보기 이미지
className="w-32 h-32 rounded-lg object-cover"

// 버튼 그룹
className="flex flex-col gap-2"

// 사진 등록 버튼
className="px-4 py-2 text-sm font-medium text-white bg-gray-700 rounded-lg"

// 삭제 버튼
className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg"
```

### 2.9 SubCategoryDropdown

**파일**: `src/components/risk-assessment/detail/shared/SubCategoryDropdown.tsx`

```tsx
interface SubCategoryDropdownProps {
  value: string;
  onChange: (value: string) => void;
  options: { id: string; name: string }[];
  placeholder?: string;
}
```

**스타일링**:
```tsx
// 드롭다운 버튼
className="w-full px-4 py-3 text-left bg-white border border-gray-300 rounded-lg flex items-center justify-between"

// 드롭다운 메뉴
className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto"

// 메뉴 아이템
className="px-4 py-3 hover:bg-orange-50 cursor-pointer text-gray-700"

// 선택된 아이템
className="px-4 py-3 bg-orange-50 text-orange-600 cursor-pointer"
```

---

## 3. 상태 관리

### 3.1 useAdhocAssessmentDetail

```tsx
interface UseAdhocAssessmentDetailReturn {
  data: AdhocAssessmentDetail | null;
  isLoading: boolean;
  error: Error | null;
  refetch: () => void;
}

interface AdhocAssessmentDetail {
  id: string;
  title: string;
  status: 'in_progress' | 'completed';
  approvers: Approver[];
  riskFactors: FrequencyIntensityRiskFactor[];
  inspectionItems: Tag[];
  nearMissTags: Tag[];
  unconfirmedWorkers: Worker[];
  additionalRisks: AdditionalRisk[];
  actionResults: ActionResult[];
}
```

### 3.2 useTagInput

```tsx
function useTagInput(
  assessmentId: string,
  type: 'inspection' | 'nearMiss' | 'review',
  factorId?: string
) {
  const addTag = useMutation({
    mutationFn: (content: string) =>
      addTagAPI(assessmentId, type, content, factorId),
    onSuccess: () => queryClient.invalidateQueries(['adhoc-assessment', assessmentId]),
  });

  const removeTag = useMutation({
    mutationFn: (tagId: string) =>
      removeTagAPI(assessmentId, type, tagId, factorId),
    onSuccess: () => queryClient.invalidateQueries(['adhoc-assessment', assessmentId]),
  });

  return { addTag, removeTag };
}
```

### 3.3 useAdditionalRisk

```tsx
function useAdditionalRisk(assessmentId: string) {
  const create = useMutation({
    mutationFn: (data: { photo?: File; content: string }) =>
      createAdditionalRisk(assessmentId, data),
  });

  const update = useMutation({
    mutationFn: ({ riskId, data }: { riskId: string; data: { photo?: File; content: string } }) =>
      updateAdditionalRisk(assessmentId, riskId, data),
  });

  const remove = useMutation({
    mutationFn: (riskId: string) =>
      deleteAdditionalRisk(assessmentId, riskId),
  });

  return { create, update, remove };
}
```

---

## 4. API 연동

### 4.1 상세 조회

```tsx
// GET /api/risk-assessments/adhoc/{id}
async function fetchAdhocAssessmentDetail(id: string): Promise<AdhocAssessmentDetail> {
  const response = await apiClient.get(`/risk-assessments/adhoc/${id}`);
  return response.data;
}
```

### 4.2 태그 관리

```tsx
// POST /api/risk-assessments/adhoc/{id}/inspection-items
// POST /api/risk-assessments/adhoc/{id}/near-miss-tags
// POST /api/risk-assessments/adhoc/{id}/risk-factors/{factorId}/reviews
async function addTag(
  assessmentId: string,
  type: 'inspection' | 'nearMiss' | 'review',
  content: string,
  factorId?: string
): Promise<void> {
  const endpoints = {
    inspection: `/risk-assessments/adhoc/${assessmentId}/inspection-items`,
    nearMiss: `/risk-assessments/adhoc/${assessmentId}/near-miss-tags`,
    review: `/risk-assessments/adhoc/${assessmentId}/risk-factors/${factorId}/reviews`,
  };
  await apiClient.post(endpoints[type], { content });
}
```

### 4.3 추가 위험 요인 (FormData)

```tsx
// POST /api/risk-assessments/adhoc/{id}/additional-risks
async function createAdditionalRisk(
  assessmentId: string,
  data: { photo?: File; content: string }
): Promise<void> {
  const formData = new FormData();
  if (data.photo) {
    formData.append('photo', data.photo);
  }
  formData.append('content', data.content);

  await apiClient.post(
    `/risk-assessments/adhoc/${assessmentId}/additional-risks`,
    formData,
    { headers: { 'Content-Type': 'multipart/form-data' } }
  );
}
```

### 4.4 조치 결과 (FormData)

```tsx
// POST /api/risk-assessments/adhoc/{id}/action-results
async function createActionResult(
  assessmentId: string,
  data: { photo?: File; subCategoryId: string; content: string }
): Promise<void> {
  const formData = new FormData();
  if (data.photo) {
    formData.append('photo', data.photo);
  }
  formData.append('subCategoryId', data.subCategoryId);
  formData.append('content', data.content);

  await apiClient.post(
    `/risk-assessments/adhoc/${assessmentId}/action-results`,
    formData,
    { headers: { 'Content-Type': 'multipart/form-data' } }
  );
}
```

---

## 5. 유틸리티 함수

### 5.1 빈도·강도 등급 계산

```tsx
// src/utils/risk-assessment/gradeCalculator.ts

type Grade = 'low' | 'medium' | 'high';

export function calculateGrade(frequency: number, intensity: number): Grade {
  const score = frequency * intensity;
  if (score <= 4) return 'low';
  if (score <= 8) return 'medium';
  return 'high';
}

export function getGradeLabel(grade: Grade): string {
  const labels = {
    low: '하등급',
    medium: '중등급',
    high: '상등급',
  };
  return labels[grade];
}

export function getGradeColor(grade: Grade): string {
  const colors = {
    low: 'green',
    medium: 'yellow',
    high: 'red',
  };
  return colors[grade];
}
```

---

## 6. 구현 체크리스트

### 6.1 페이지 및 레이아웃

- [ ] AdhocAssessmentDetailPage
- [ ] AdhocDetailHeader

### 6.2 위험요인 관련

- [ ] FrequencyIntensityCard
- [ ] ActionInfoSection
- [ ] ReviewContentInput
- [ ] ReviewTagList

### 6.3 선택 정보 입력

- [ ] OptionalInfoSection
- [ ] TagInputField
- [ ] TagBadge

### 6.4 접이식 섹션

- [ ] CollapsibleSection
- [ ] UnconfirmedWorkerSection
- [ ] AdditionalRiskSection
- [ ] AdditionalRiskCard
- [ ] ActionResultSection
- [ ] ActionResultCard

### 6.5 모달

- [ ] AdditionalRiskModal
- [ ] ActionResultModal
- [ ] PhotoUploader
- [ ] PrivacyConsentModal
- [ ] SuccessMessageModal

### 6.6 공통 컴포넌트

- [ ] SubCategoryDropdown

### 6.7 훅 및 API

- [ ] useAdhocAssessmentDetail
- [ ] useTagInput
- [ ] useAdditionalRisk
- [ ] useActionResult
- [ ] 관련 API 함수들

### 6.8 유틸리티

- [ ] calculateGrade
- [ ] getGradeLabel
- [ ] getGradeColor

---

## 7. 연결 문서

- 기획 문서: `docs/ui-specs/pc/plans/2026-01-16-수시위험성평가상세보기-작업기간중-기획.md`
- 수시 만들기 구현: `docs/ui-specs/pc/specs/2026-01-16-수시빈도강도위험성평가만들기-구현.md`
